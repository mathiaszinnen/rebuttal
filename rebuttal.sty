%% rebuttal.sty
%% Copyright 2018 Sergiu Deitsch
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Sergiu Deitsch.
%
% This work consists of the files rebuttal.sty and letter.tex.

\ProvidesPackage{rebuttal}

\PassOptionsToPackage{authormarkup=none}{changes}
\PassOptionsToPackage{svgnames,x11names}{xcolor}

\RequirePackage{calc}
\RequirePackage{changes}
\RequirePackage{etoolbox}
\RequirePackage{fdsymbol}
\RequirePackage{marginnote}
\RequirePackage{pdfcomment}
\RequirePackage{pgfkeys}
\RequirePackage{todonotes}
\RequirePackage{xcolor}
\RequirePackage{xstring}

\pgfkeys{
  /rebuttal/title/font/.store in=\rebuttal@titlefont,
  /rebuttal/title/font=\normalfont\bfseries,
  /rebuttal/title/format/.code=#1:,
  /rebuttal/comment/font/.store in=\rebuttal@commentfont,
  /rebuttal/comment/font=\normalfont\itshape,
  /rebuttal/comment/label/font/.store in=\rebuttal@commentlabelfont,
  /rebuttal/comment/label/font=\normalfont\rmfamily\bfseries,
  /rebuttal/answer/font/.store in=\rebuttal@answerfont,
  /rebuttal/answer/font=\normalfont,
  /rebuttal/answer/label/.store in=\rebuttal@answerlabel,
  /rebuttal/answer/label={\ensuremath{\smallblacktriangleright}},
  /rebuttal/answer/label/font/.store in=\rebuttal@answerlabelfont,
  /rebuttal/answer/label/font=\normalfont,
  /rebuttal/reference/font/.store in=\rebuttal@referencefont,
  /rebuttal/reference/font={%
    \tiny\bfseries%
  },
  % TODO does not work within \todo
  %/rebuttal/reference/.code={%
  %},
}

\let\rebuttalanswerlabel\rebuttal@answerlabel

\def\rebuttal@reference#1{%
  \begingroup
    \rebuttal@referencefont
    \begingroup
      \color{rebuttal@#1}%
      \MakeUppercase{\rebuttal@id}%
      \csname therebuttal@#1\endcsname
    \endgroup
    \normalfont
    ~%
    (\ref{\pgfkeysvalueof{/rebuttal/#1/ref}})%
  \endgroup
}

\newcommand\rebuttal@define@keys[2]{
  \pgfkeys{
    /rebuttal/#1/label/.initial=,
    /rebuttal/#1/label/.value required,
    /rebuttal/#1/ref/.initial=,
    /rebuttal/#1/ref/.value required,
    /rebuttal/#1/color/.code=\colorlet{rebuttal@#1}{##1},
    /rebuttal/#1/color=#2,
    /rebuttal/#1/font/.value required,
    /rebuttal/#1/font/.code={
      \expandafter\def\csname rebuttal@#1@font\endcsname{##1}%
    },
    /rebuttal/#1/font=\normalfont\mdseries,
  }
}

\rebuttal@define@keys{addition}{MediumSeaGreen}
\rebuttal@define@keys{deletion}{Firebrick3}
\rebuttal@define@keys{change}{DodgerBlue3}

\newcommand\rebuttal@command[3]{%
  \newcounter{rebuttal@#1}%
  \AfterPreamble{%
    \@ifpackageloaded{cleveref}{%
      \crefname{rebuttal@#1}{#1}{#1s}%
    }{}
  }
  \expandafter\newcommand\csname #1\endcsname[#3][]{%
    \refstepcounter{rebuttal@#1}%
    \begingroup
      \tikzset{notestyleraw/.append style={
        inner sep=\z@,
        rounded corners=\z@,
      }}%
      \pgfqkeys{/rebuttal/#1}{##1}%
      \label{\pgfkeysvalueof{/rebuttal/#1/label}}%
      \colorlet{Changes@Color}{rebuttal@#1}%
      \begingroup
        \@nameuse{rebuttal@#1@font}%
        #2%
      \endgroup
      \StrLeft{#1}{1}[\rebuttal@id]%
      \todo
      [
        backgroundcolor=none,
        bordercolor=none,
        linecolor=rebuttal@#1,
        %size=\tiny,
      ]{%
        \rebuttal@reference{#1}%
        %\pgfkeys{/rebuttal/reference=#1}
      }%
    \endgroup
}}

\rebuttal@command{addition}{\added{#2}}{2}
\rebuttal@command{deletion}{\deleted{#2}}{2}
\rebuttal@command{change}{\replaced{#2}{#3}}{3}

\newcounter{rebuttal}
\newcounter{rebuttal@comment}
\newcounter{rebuttal@answer}

\renewcommand\therebuttal@comment{%
  \arabic{rebuttal}.\arabic{rebuttal@comment}%
}

\let\theHrebuttal@comment\therebuttal@comment

\renewcommand\therebuttal@answer{%
  \arabic{rebuttal}.\arabic{rebuttal@answer}%
}

\newdimen\rebuttal@parindent
\newdimen\rebuttal@parskip
\newdimen\rebuttal@labelsep
\newdimen\rebuttal@leftmargin

\newcommand\rebuttal@restorepar{%
  \parindent\rebuttal@parindent%
  \parskip\rebuttal@parskip%
}

\newcommand\rebuttal@storepar{%
  \rebuttal@parindent\parindent
  \rebuttal@parskip\parskip
}

% TODO Comment labels tooltips
\newenvironment{rebuttal}[1][]{%
  \begingroup
  \setcounter{rebuttal@comment}{0}
  \refstepcounter{rebuttal}%
  \pagenumbering{roman}%
  \if@twocolumn\onecolumn\fi
  \begingroup
  \par
  \addvspace{\bigskipamount}%
  \ifstrempty{#1}{}{%
    \ifx\pdfbookmark\@undefined\else
      \pdfbookmark{#1}{rebuttalcomment.\therebuttal@comment}%
    \fi
    \noindent\rebuttal@titlefont\strut
    \pgfkeys{/rebuttal/title/format=#1}%
  }%
  \par%
  \vspace*{\medskipamount}%
  \@afterheading
  \rebuttal@storepar
  \begin{list}{\pdftooltip{\rebuttal@answerlabel}{Reply}}{%
    \let\rebuttal@oldmakelabel\makelabel%
    \renewcommand\makelabel[1]{\rlap{\rebuttal@commentlabelfont ##1}\hfil\null}%
    %\setlength{\parsep}{\smallskipamount}%
    %\setlength{\labelsep}{1pt}%
    %\setlength{\topsep}{\z@}%
    %\setlength{\partopsep}{\bigskipamount}
    \rebuttal@leftmargin\leftmargin
    \setlength{\leftmargin}{\z@}%
  }
  \newenvironment{comment}{%
    \preto\item{%
      \pdfbookmark[1]{Comment~\therebuttal@comment}{rebuttal@comment.\therebuttal@comment}%
    }
    \rebuttal@restorepar
    % Do not allow to place answers within a comment by undefining the answer
    % environment
    \let\answer\@undefined
    \let\endanswer\@undefined
    \refstepcounter{rebuttal@comment}
    %\settowidth{\labelwidth}{\rebuttal@commentlabelfont #1}
    %\addtolength{\labelwidth}{1em}
    \item
    [%
      \therebuttal@comment%
    ]%
    \begingroup
    \rebuttal@commentfont
    \let\makelabel\rebuttal@oldmakelabel
  }{\endgroup}
  \newenvironment{answer}{%
    \normalfont\rebuttal@answerfont%
    \rebuttal@restorepar
    \rebuttal@labelsep\labelsep
    \newcommand\rebuttal@makelabel[1]{\rebuttal@answerlabelfont ####1\enspace}
    \renewcommand\makelabel[1]{\rebuttal@makelabel{####1}}
    \refstepcounter{rebuttal@answer}
    %\settowidth\labelwidth{\rebuttal@makelabel{\rebuttal@answerlabel}}%
    \labelwidth\z@
    \labelsep\z@
    %\labelwidth=-1\labelwidth
    %\addtolength\labelwidth{-.5\labelwidth}%
    \pdfbookmark[2]{Anwser to~\therebuttal@comment}{rebuttal@answer.\therebuttal@answer}%
    \item\begingroup
    \labelsep\rebuttal@labelsep
  }{\endgroup}
}{%
  \end{list}%
  \endgroup
  \par\addvspace{\bigskipamount}%
  \endgroup
}

% Support cleveref
\AfterPreamble{%
  \@ifpackageloaded{cleveref}{%
    \crefname{rebuttal@comment}{comment}{comments}
    \crefname{rebuttal@answer}{answer}{answers}
    \Crefname{rebuttal@comment}{Comment}{Comments}
    \Crefname{rebuttal@answer}{Answer}{Answers}
  }{}
}

\newcommand\rebuttalset[1]{%
  \pgfqkeys{/rebuttal}{#1}%
}

% vim: ft=tex
